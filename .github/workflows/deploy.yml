apiVersion: batch/v1
kind: Job
metadata:
  name: django-migrate
  namespace: default
spec:
  ttlSecondsAfterFinished: 300  # Auto-limpieza después de 5 min
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: django-migrate
    spec:
      serviceAccountName: hireloop-ksa
      restartPolicy: Never
      
      containers:
        # ============ DJANGO MIGRATIONS ============
        - name: migrate
          image: us-central1-docker.pkg.dev/hireloop-476222/hireloop-images/hireloop:latest
          envFrom:
            - secretRef:
                name: hireloop-secrets
            - configMapRef:
                name: hireloop-config
          env:
            - name: DATABASE_HOST
              value: "127.0.0.1"
            - name: DATABASE_PORT
              value: "5432"
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "=== Waiting for Cloud SQL Proxy ==="
              for i in {1..30}; do
                if python -c "import socket; s=socket.socket(); s.settimeout(1); s.connect(('127.0.0.1', 5432)); s.close()" 2>/dev/null; then
                  echo "✅ Proxy ready"
                  break
                fi
                echo "  → Attempt $i/30: Proxy not ready... waiting 2s"
                sleep 2
                if [ $i -eq 30 ]; then
                  echo "❌ Timeout waiting for proxy"
                  exit 1
                fi
              done
              
              echo "=== Running Django migrations ==="
              python manage.py migrate --noinput
              
              echo "=== Creating superuser (if needed) ==="
              python manage.py shell -c "
              from django.contrib.auth import get_user_model;
              User = get_user_model();
              if not User.objects.filter(username='admin').exists():
                  User.objects.create_superuser('admin', 'admin@hireloop.com', 'changeme123');
                  print('✅ Superuser created: admin / changeme123');
              else:
                  print('ℹ️  Superuser already exists');
              " || echo "Note: Superuser creation skipped or failed"
              
              echo "=== Collecting static files ==="
              python manage.py collectstatic --noinput --clear || echo "Static files collection failed"
              
              echo "✅ Migration job completed successfully!"

        # ============ CLOUD SQL PROXY ============
        - name: cloud-sql-proxy
          image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.13.0
          args:
            - "--address=0.0.0.0"
            - "--port=5432"
            - "--structured-logs"
            - "hireloop-476222:us-central1:hireloop-db"
          securityContext:
            runAsNonRoot: true
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"