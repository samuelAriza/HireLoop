name: Deploy to GKE

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: hireloop-476222
  GAR_LOCATION: us-central1
  REPOSITORY: hireloop-images
  IMAGE: hireloop
  CLUSTER: hireloop-cluster
  CLUSTER_ZONE: us-central1-a
  DEPLOYMENT_NAME: hireloop-deployment
  NAMESPACE: default

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Google Cloud authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker
        run: gcloud auth configure-docker $GAR_LOCATION-docker.pkg.dev --quiet

      - name: Build & Push
        run: |
          IMAGE_TAG=${{ github.sha }}
          IMAGE_FULL=$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:$IMAGE_TAG
          IMAGE_LATEST=$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE:latest
          
          docker build -t $IMAGE_FULL -t $IMAGE_LATEST .
          docker push $IMAGE_FULL
          docker push $IMAGE_LATEST
          
          echo "IMAGE_FULL=$IMAGE_FULL" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER }}
          location: ${{ env.CLUSTER_ZONE }}

      - name: Deploy to GKE
        run: |
          set -e
          
          # Actualiza la imagen con el tag espec√≠fico
          kubectl set image deployment/$DEPLOYMENT_NAME \
            $IMAGE=${{ env.IMAGE_FULL }} -n $NAMESPACE
          
          # Fuerza rollout con timestamp
          kubectl patch deployment $DEPLOYMENT_NAME -n $NAMESPACE -p \
            "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"redeployed-at\":\"$(date +%s)\"}}}}}"
          
          echo "‚úÖ Deployment actualizado con imagen: ${{ env.IMAGE_FULL }}"

      - name: Wait for rollout
        run: |
          echo "‚è≥ Esperando rollout (timeout: 10 minutos)..."
          kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE --timeout=600s
          echo "‚úÖ Rollout completado exitosamente"

      - name: Run migrations
        run: |
          echo "üîÑ Running database migrations..."
          
          # Crear Job temporal para migraciones
          cat <<EOF | kubectl apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: django-migrate-${{ github.sha }}
            namespace: $NAMESPACE
          spec:
            ttlSecondsAfterFinished: 120
            backoffLimit: 2
            template:
              spec:
                serviceAccountName: hireloop-ksa
                restartPolicy: Never
                shareProcessNamespace: true
                imagePullSecrets:
                  - name: gcp-artifact-registry
                
                containers:
                # ============ DJANGO MIGRATE CONTAINER ============
                - name: migrate
                  image: ${{ env.IMAGE_FULL }}
                  envFrom:
                  - secretRef:
                      name: hireloop-secrets
                  - configMapRef:
                      name: hireloop-config
                  env:
                  - name: DATABASE_HOST
                    value: "127.0.0.1"
                  - name: DATABASE_PORT
                    value: "5432"
                  command:
                  - /bin/bash
                  - -c
                  - |
                    set -e
                    echo "=== Waiting for Cloud SQL Proxy ==="
                    sleep 10
                    
                    # Verificar que el proxy est√© listo
                    for i in {1..20}; do
                      if python -c "import socket; s=socket.socket(); s.settimeout(2); s.connect(('127.0.0.1', 5432)); s.close()" 2>/dev/null; then
                        echo "‚úÖ Cloud SQL Proxy is ready"
                        break
                      fi
                      echo "Waiting for proxy... attempt \$i/20"
                      sleep 2
                    done
                    
                    echo "=== Running Django migrations ==="
                    python manage.py migrate --noinput
                    
                    echo "=== Collecting static files ==="
                    python manage.py collectstatic --noinput --clear
                    
                    echo "‚úÖ Migrations completed successfully"
                    
                    # Detener el Cloud SQL Proxy para que el Job termine
                    echo "=== Stopping Cloud SQL Proxy ==="
                    python -c "import urllib.request; urllib.request.urlopen('http://localhost:9091/quitquitquit', data=b'').read()" 2>/dev/null || true
                    sleep 5
                  resources:
                    requests:
                      cpu: "100m"
                      memory: "256Mi"
                    limits:
                      cpu: "500m"
                      memory: "512Mi"
                  lifecycle:
                    preStop:
                      exec:
                        command: ["/bin/sh", "-c", "sleep 1"]
                
                # ============ CLOUD SQL PROXY SIDECAR ============
                - name: cloud-sql-proxy
                  image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.13.0
                  args:
                  - "--address=0.0.0.0"
                  - "--port=5432"
                  - "--quitquitquit"
                  - "--structured-logs"
                  - "--credentials-file=/secrets/credentials.json"
                  - "hireloop-476222:us-central1:hireloop-db"
                  volumeMounts:
                  - name: cloudsql-credentials
                    mountPath: /secrets
                    readOnly: true
                  securityContext:
                    runAsNonRoot: true
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "100m"
                    limits:
                      memory: "256Mi"
                      cpu: "200m"
                
                # ============ VOLUMES ============
                volumes:
                - name: cloudsql-credentials
                  secret:
                    secretName: cloudsql-credentials
          EOF
          
          echo "‚è≥ Waiting for migration job to complete (max 6 minutes)..."
          
          # Esperar a que el job complete
          if kubectl wait --for=condition=complete --timeout=360s job/django-migrate-${{ github.sha }} -n $NAMESPACE; then
            echo "‚úÖ Migrations completed successfully"
            kubectl logs job/django-migrate-${{ github.sha }} -c migrate -n $NAMESPACE --tail=50
          else
            echo "‚ùå Migration job failed or timed out"
            echo ""
            echo "=== Django container logs ==="
            kubectl logs job/django-migrate-${{ github.sha }} -c migrate -n $NAMESPACE --tail=100 || true
            echo ""
            echo "=== Cloud SQL Proxy logs ==="
            kubectl logs job/django-migrate-${{ github.sha }} -c cloud-sql-proxy -n $NAMESPACE --tail=50 || true
            echo ""
            echo "=== Job status ==="
            kubectl describe job/django-migrate-${{ github.sha }} -n $NAMESPACE || true
            exit 1
          fi

      - name: Verify deployment
        run: |
          echo "üìä Estado del deployment:"
          kubectl get deployment $DEPLOYMENT_NAME -n $NAMESPACE
          echo ""
          echo "üì¶ Pods:"
          kubectl get pods -n $NAMESPACE -l app=$IMAGE
          echo ""
          echo "üìù √öltimos eventos:"
          kubectl get events -n $NAMESPACE --sort-by='.lastTimestamp' | tail -20

      - name: Cleanup old resources
        if: success()
        run: |
          echo "üßπ Limpiando recursos antiguos..."
          
          # Eliminar pods fallidos
          kubectl delete pods -n $NAMESPACE \
            -l app=$IMAGE \
            --field-selector=status.phase=Failed \
            --grace-period=0 --force 2>/dev/null || true
          
          # Eliminar pods completados
          kubectl delete pods -n $NAMESPACE \
            -l app=$IMAGE \
            --field-selector=status.phase=Succeeded \
            --grace-period=0 --force 2>/dev/null || true
          
          # Eliminar jobs antiguos (mantener solo los √∫ltimos 3)
          kubectl get jobs -n $NAMESPACE -l job-type=migration \
            --sort-by=.metadata.creationTimestamp \
            -o name | head -n -3 | xargs -r kubectl delete -n $NAMESPACE 2>/dev/null || true
          
          echo "‚úÖ Cleanup completado"